# Example configuration for API Gateway
# This is a reference configuration showing all available options

server:
  # Address to bind the server to
  bind_address: "0.0.0.0"

  # Port to listen on
  port: 8443

  # TLS configuration (optional - if not provided, runs in HTTP mode)
  # tls:
  #   cert_path: "/path/to/cert.pem"
  #   key_path: "/path/to/key.pem"
  #   min_version: "1.2"  # or "1.3"

  # Connection timeout in seconds
  connection_timeout_secs: 60

  # Maximum concurrent connections
  max_connections: 10000

  # Request timeout in seconds
  request_timeout_secs: 30

# Upstream services configuration
upstreams:
  # Example upstream service
  - id: "user-service"
    base_url: "http://localhost:8081"
    timeout_secs: 30
    pool_max_idle_per_host: 10
    health_check_path: "/health"

  - id: "product-service"
    base_url: "http://localhost:8082"
    timeout_secs: 30
    pool_max_idle_per_host: 10

  - id: "order-service"
    base_url: "http://localhost:8083"
    timeout_secs: 30
    pool_max_idle_per_host: 10

# Routes configuration
routes:
  # Exact match example
  - id: "get-users"
    methods: ["GET"]
    path: "/api/users"
    upstream_id: "user-service"

  # Path parameter example
  - id: "get-user-by-id"
    methods: ["GET"]
    path: "/api/users/{id}"
    upstream_id: "user-service"

  # Multiple methods example
  - id: "users-crud"
    methods: ["POST", "PUT", "DELETE"]
    path: "/api/users/{id}"
    upstream_id: "user-service"

  # Prefix match example (all requests starting with /api/products/)
  - id: "product-api"
    methods: ["GET", "POST", "PUT", "DELETE"]
    path: "/api/products/*"
    upstream_id: "product-service"

  # Strip prefix example (removes /api/v1 before forwarding)
  - id: "orders-v1"
    methods: ["GET", "POST"]
    path: "/api/v1/orders/*"
    upstream_id: "order-service"
    strip_prefix: "/api/v1"

  # Custom upstream path example
  - id: "legacy-orders"
    methods: ["GET"]
    path: "/legacy/orders"
    upstream_id: "order-service"
    upstream_path: "/api/orders"

  # Custom timeout example
  - id: "slow-operation"
    methods: ["POST"]
    path: "/api/reports/generate"
    upstream_id: "product-service"
    timeout_secs: 120

  # Protected route requiring authentication
  - id: "protected-users"
    methods: ["GET", "POST", "PUT", "DELETE"]
    path: "/api/admin/users/*"
    upstream_id: "user-service"
    auth_required: true
    required_roles: ["admin"]  # RBAC: User must have 'admin' role

  # Route requiring specific permissions
  - id: "create-order"
    methods: ["POST"]
    path: "/api/orders"
    upstream_id: "order-service"
    auth_required: true
    required_permissions: ["orders:create"]  # PBAC: User must have this permission

  # Route requiring multiple permissions
  - id: "manage-products"
    methods: ["PUT", "DELETE"]
    path: "/api/products/{id}"
    upstream_id: "product-service"
    auth_required: true
    required_permissions: ["products:write", "products:delete"]

  # Route with rate limiting (per IP)
  - id: "search-products"
    methods: ["GET"]
    path: "/api/products/search"
    upstream_id: "product-service"
    rate_limit:
      limit: 100  # 100 requests
      window_secs: 60  # per minute
      algorithm: "token_bucket"
      key_type: "ip"  # Per client IP

  # Route with strict rate limiting (per user, sliding window)
  - id: "create-order-limited"
    methods: ["POST"]
    path: "/api/orders/create"
    upstream_id: "order-service"
    auth_required: true
    rate_limit:
      limit: 10  # 10 requests
      window_secs: 60  # per minute
      algorithm: "sliding_window"  # Strict enforcement
      key_type: "user"  # Per authenticated user

  # Route with composite rate limiting (user + endpoint)
  - id: "expensive-report"
    methods: ["POST"]
    path: "/api/reports/expensive"
    upstream_id: "product-service"
    auth_required: true
    timeout_secs: 300  # 5 minutes
    rate_limit:
      limit: 5  # 5 requests
      window_secs: 3600  # per hour
      algorithm: "sliding_window"
      key_type: "user_endpoint"  # Per user per endpoint

# Authentication configuration (optional - if not provided, authentication is disabled)
# NOTE: For production, load secrets from environment variables instead of config file
auth:
  # JWT algorithm for token validation (HS256, RS256, or ES256)
  jwt_algorithm: "HS256"

  # JWT secret key for HS256 algorithm (symmetric)
  # For production, use environment variable: GATEWAY_JWT_SECRET
  # jwt_secret: "your-secret-key-here-min-256-bits"

  # JWT public key for RS256/ES256 algorithms (asymmetric)
  # For production, use environment variable: GATEWAY_JWT_PUBLIC_KEY
  # jwt_public_key: |
  #   -----BEGIN PUBLIC KEY-----
  #   MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA...
  #   -----END PUBLIC KEY-----

  # Cookie name for session token (default: session_token)
  cookie_name: "session_token"

  # JWT issuer claim validation (optional - validates 'iss' claim)
  # jwt_issuer: "https://auth.example.com"

  # JWT audience claim validation (optional - validates 'aud' claim)
  # jwt_audience: "api-gateway"

# Rate limiting configuration (optional - if not provided, rate limiting is disabled)
# NOTE: Requires Redis to be running and accessible
# rate_limiting:
#   # Redis connection URL
#   redis_url: "redis://localhost:6379"
#
#   # Failure mode when Redis is unavailable
#   # - "fail_closed": Reject requests with 503 Service Unavailable (secure, default)
#   # - "fail_open": Allow requests to proceed (high availability)
#   failure_mode: "fail_closed"
#
#   # Global default rate limit (applied to routes without specific rate limits)
#   default_limit:
#     # Maximum number of requests allowed
#     limit: 1000
#
#     # Time window in seconds
#     window_secs: 3600  # 1 hour
#
#     # Rate limiting algorithm
#     # - "token_bucket": Allows bursts (default)
#     # - "sliding_window": Strict limit enforcement
#     algorithm: "token_bucket"
#
#     # Burst capacity for token bucket (optional, defaults to limit)
#     burst_capacity: 1000
#
#     # Key type for rate limiting
#     # - "ip": Rate limit by client IP address
#     # - "user": Rate limit by authenticated user ID
#     # - "endpoint": Rate limit by route/endpoint
#     # - "user_endpoint": Composite (user + endpoint)
#     # - "ip_endpoint": Composite (IP + endpoint)
#     key_type: "ip"

# Logging configuration (optional - if not provided, logs to stdout with INFO level)
logging:
  # Log level (ERROR, WARN, INFO, DEBUG, TRACE)
  level: "INFO"

  # Log format (json, text)
  format: "json"

  # Enable structured JSON logging
  structured: true

  # Enable sensitive data redaction
  redaction_enabled: true

  # Log sampling rate (0.0 to 1.0) - 1.0 means log everything
  sampling_rate: 1.0

  # Log output destinations (can configure multiple sinks)
  sinks:
    # Standard output (default)
    - type: stdout
      enabled: true
      min_level: INFO

    # File logging with rotation
    # - type: file
    #   enabled: true
    #   min_level: INFO
    #   file:
    #     path: "/var/log/api-gateway/gateway.log"
    #     rotation_enabled: true
    #     max_size_mb: 100
    #     max_backups: 10
    #     max_age_days: 30

    # Elasticsearch logging
    # - type: elasticsearch
    #   enabled: true
    #   min_level: INFO
    #   elasticsearch:
    #     urls:
    #       - "https://elasticsearch.example.com:9200"
    #     index: "api-gateway-logs-%Y.%m.%d"
    #     batch_size: 100
    #     flush_interval_secs: 5
    #     username: "gateway_logger"
    #     password: "${ELASTICSEARCH_PASSWORD}"

    # AWS CloudWatch Logs
    # - type: cloudwatch
    #   enabled: true
    #   min_level: INFO
    #   cloudwatch:
    #     region: "us-east-1"
    #     log_group: "/aws/api-gateway/production"
    #     log_stream: "gateway-{instance_id}"
    #     batch_size: 100
    #     flush_interval_secs: 5

    # Splunk HEC (HTTP Event Collector)
    # - type: splunk
    #   enabled: true
    #   min_level: INFO
    #   splunk:
    #     endpoint: "https://splunk.example.com:8088/services/collector"
    #     token: "${SPLUNK_HEC_TOKEN}"
    #     sourcetype: "api_gateway"
    #     index: "production"
    #     batch_size: 100
    #     flush_interval_secs: 5

# Observability configuration (optional - for operational readiness)
observability:
  # Enable Prometheus metrics export
  metrics_enabled: true

  # Metrics export port (default: 9090)
  metrics_port: 9090

  # Health check configuration
  health_checks:
    # Enable liveness check endpoint (/health/live)
    liveness_enabled: true

    # Enable readiness check endpoint (/health/ready)
    readiness_enabled: true

    # Check Redis connectivity in readiness probe
    check_redis: true

    # Check upstream connectivity in readiness probe
    check_upstreams: false

  # Distributed tracing configuration (OpenTelemetry)
  # tracing:
  #   enabled: true
  #   backend: "jaeger"  # jaeger, zipkin, or otlp
  #   endpoint: "http://jaeger-collector:14268/api/traces"
  #   service_name: "api-gateway"
  #   sampling_rate: 0.1  # Sample 10% of requests
