apiVersion: v1
kind: ConfigMap
metadata:
  name: api-gateway-config
  namespace: default
  labels:
    app: api-gateway
data:
  # Environment variable overrides
  log_level: "info"
  server_port: "8080"
  metrics_port: "9090"

  # Full configuration file
  # This should be customized for your environment
  config.yaml: |
    server:
      bind_address: "0.0.0.0"
      port: 8080
      connection_timeout_secs: 60
      max_connections: 10000
      request_timeout_secs: 30

    # Upstream services configuration
    upstreams:
      # Example upstream service - customize for your environment
      - id: "user-service"
        base_url: "http://user-service.default.svc.cluster.local:8080"
        timeout_secs: 30
        pool_max_idle_per_host: 10
        health_check_path: "/health"

      - id: "product-service"
        base_url: "http://product-service.default.svc.cluster.local:8080"
        timeout_secs: 30
        pool_max_idle_per_host: 10

      - id: "order-service"
        base_url: "http://order-service.default.svc.cluster.local:8080"
        timeout_secs: 30
        pool_max_idle_per_host: 10

    # Routes configuration
    routes:
      # Health check routes (public, no auth required)
      - id: "health-live"
        methods: ["GET"]
        path: "/health/live"
        upstream_id: "user-service"

      - id: "health-ready"
        methods: ["GET"]
        path: "/health/ready"
        upstream_id: "user-service"

      # Metrics endpoint (internal only)
      - id: "metrics"
        methods: ["GET"]
        path: "/metrics"
        upstream_id: "user-service"

      # API routes
      - id: "get-users"
        methods: ["GET"]
        path: "/api/users"
        upstream_id: "user-service"

      - id: "get-user-by-id"
        methods: ["GET"]
        path: "/api/users/{id}"
        upstream_id: "user-service"

      - id: "product-api"
        methods: ["GET", "POST", "PUT", "DELETE"]
        path: "/api/products/*"
        upstream_id: "product-service"

      # Protected routes requiring authentication
      - id: "protected-users"
        methods: ["GET", "POST", "PUT", "DELETE"]
        path: "/api/admin/users/*"
        upstream_id: "user-service"
        auth_required: true
        required_roles: ["admin"]

      # Routes with rate limiting
      - id: "search-products"
        methods: ["GET"]
        path: "/api/products/search"
        upstream_id: "product-service"
        rate_limit:
          limit: 100
          window_secs: 60
          algorithm: "token_bucket"
          key_type: "ip"

    # Authentication configuration
    # Secrets are loaded from environment variables
    auth:
      jwt_algorithm: "HS256"
      cookie_name: "session_token"
      # jwt_secret is loaded from GATEWAY_AUTH__JWT_SECRET env var
      # jwt_issuer: "https://auth.example.com"
      # jwt_audience: "api-gateway"

    # Rate limiting configuration
    # rate_limiting:
    #   redis_url: "redis://redis-master.default.svc.cluster.local:6379"
    #   failure_mode: "fail_closed"
    #   default_limit:
    #     limit: 1000
    #     window_secs: 3600
    #     algorithm: "token_bucket"
    #     key_type: "ip"
